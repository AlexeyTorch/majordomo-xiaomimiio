<link rel="stylesheet" href="../templates/xiaomimiio/css/bootstrap-select.min.css">

<form action="?" method="post" enctype="multipart/form-data" name="frmEdit" class="form-horizontal">
	[#if OK#]
	<div class="alert alert-success"><#LANG_DATA_SAVED#></div>
	[#endif OK#]
	
	[#if ERR#]
	<div class="alert alert-error"><#LANG_FILLOUT_REQURED#></div>
	[#endif ERR#]
	
	<fieldset>
		[#if ID=""#]
		<legend><#LANG_ADD#> <#LANG_DEVICE#></legend>
		[#endif ID#]

		<div class="form-group">
			<label class="col-lg-3 control-label"[#if ERR_TITLE#] style="color:red;font-weight:bold"[#endif#]>
				<#LANG_TITLE#> (*):
			</label>
			<div class="col-lg-4"><input type="text" class="form-control" name="title" value="[#TITLE#]" id="title"></div>
		</div>

		<div class="form-group">
			<label class="col-lg-3 control-label"[#if ERR_IP#] style="color:red;font-weight:bold"[#endif#]>
				IP (*):
			</label>
			<div class="col-lg-4"><input type="text" class="form-control" name="ip" value="[#IP#]" id="ip"></div>
		</div>

		<div class="form-group">
			<label class="col-lg-3 control-label"[#if ERR_TOKEN#] style="color:red;font-weight:bold"[#endif#]>
				<#LANG_XIMI_APP_TOKEN#>:
			</label>
			<div class="col-lg-4"><input type="text" class="form-control" name="token" value="[#TOKEN#]" id="token"></div>
		</div>

		<div class="form-group">
			<label class="col-lg-3 control-label"[#if ERR_DEVICE_TYPE#] style="color:red;font-weight:bold"[#endif#]>
				<#LANG_TYPE#>:
			</label>
			<div class="col-lg-4">
				<select name="device_type" class="selectpicker show-tick form-control">
					<!-- шаблон для нового устройства
					<option data-content="<img src='../templates/xiaomimiio/img/small/NEW_DEV.png' width='20' height='20'> NEW_DEV_NAME" value="NEW_DEV" [#if DEVICE_TYPE="NEW_DEV"#] selected[#endif#]></option>
					-->
					<option value=""></option>
					<optgroup label="Aqara">
					<option data-content="<img src='../templates/xiaomimiio/img/small/lumi.acpartner.v3.png' width='20' height='20'> Aqara AC Companion Gateway" value="lumi.acpartner.v3" [#if DEVICE_TYPE="lumi.acpartner.v3"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/lumi.camera.aq1.png' width='20' height='20'> Aqara Smart Camera Gateway" value="lumi.camera.aq1" [#if DEVICE_TYPE="lumi.camera.aq1"#] selected[#endif#]></option>
					</optgroup>
					<optgroup label="Xiaomi">
					<option data-content="<img src='../templates/xiaomimiio/img/small/zhimi.humidifier.v1.png' width='20' height='20'> Mi Air Humidifier" value="zhimi.humidifier.v1" [#if DEVICE_TYPE="zhimi.humidifier.v1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/zhimi.humidifier.ca1.png' width='20' height='20'> Mi Air Humidifier 2" value="zhimi.humidifier.ca1" [#if DEVICE_TYPE="zhimi.humidifier.ca1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/zhimi.airpurifier.ma2.png' width='20' height='20'> Mi Air Purifier 2S" value="zhimi.airpurifier.ma2" [#if DEVICE_TYPE="zhimi.airpurifier.ma2"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/chuangmi.ir.v2.png' width='20' height='20'> Mi IR Remote 360" value="chuangmi.ir.v2" [#if DEVICE_TYPE="chuangmi.ir.v2"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/xiaomi.wifispeaker.v1.png' width='20' height='20'> Mi Internet Speaker" value="xiaomi.wifispeaker.v1" [#if DEVICE_TYPE="xiaomi.wifispeaker.v1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/yeelink.light.lamp1.png' width='20' height='20'> Mi LED Desk Lamp" value="yeelink.light.lamp1" [#if DEVICE_TYPE="yeelink.light.lamp1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/lumi.gateway.v3.png' width='20' height='20'> Mi Smart Home Gateway 2" value="lumi.gateway.v3" [#if DEVICE_TYPE="lumi.gateway.v3"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/zimi.powerstrip.v2.png' width='20' height='20'> Mi Smart Power Strip 6 Plugs" value="zimi.powerstrip.v2" [#if DEVICE_TYPE="zimi.powerstrip.v2"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/chuangmi.plug.v1.png' width='20' height='20'> Mi Smart Socket Plug with USB" value="chuangmi.plug.v1" [#if DEVICE_TYPE="chuangmi.plug.v1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/chuangmi.plug.v3.png' width='20' height='20'> Mi Smart Socket Plug with 2 USB" value="chuangmi.plug.v3" [#if DEVICE_TYPE="chuangmi.plug.v3"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/chuangmi.plug.m1.png' width='20' height='20'> Mi Smart Socket Plug 2" value="chuangmi.plug.m1" [#if DEVICE_TYPE="chuangmi.plug.m1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/isa.camera.isc5.png' width='20' height='20'> Mi Square Smart Camera" value="isa.camera.isc5" [#if DEVICE_TYPE="isa.camera.isc5"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/isa.camera.df3.png' width='20' height='20'> Mi Dafang Smart Camera 120" value="isa.camera.df3" [#if DEVICE_TYPE="isa.camera.df3"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/roborock.vacuum.s5.png' width='20' height='20'> Mi Roborock S50/S51" value="roborock.vacuum.s5" [#if DEVICE_TYPE="roborock.vacuum.s5"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/rockrobo.vacuum.v1.png' width='20' height='20'> Mi Vacuum Cleaner" value="rockrobo.vacuum.v1" [#if DEVICE_TYPE="rockrobo.vacuum.v1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/xiaomi.repeater.v2.png' width='20' height='20'> Mi WiFi Amplifier 2" value="xiaomi.repeater.v2" [#if DEVICE_TYPE="xiaomi.repeater.v2"#] selected[#endif#]></option>
					</optgroup>
					<optgroup label="Philips">
					<option data-content="<img src='../templates/xiaomimiio/img/small/philips.light.ceiling.png' width='20' height='20'> Philips EyeCare Smart Ceiling Lamp" value="philips.light.ceiling" [#if DEVICE_TYPE="philips.light.ceiling"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/philips.light.sread1.png' width='20' height='20'> Philips EyeCare Smart Desk Lamp 2" value="philips.light.sread1" [#if DEVICE_TYPE="philips.light.sread1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/philips.light.bulb.png' width='20' height='20'> Philips Light Bulb" value="philips.light.bulb" [#if DEVICE_TYPE="philips.light.bulb"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/philips.light.candle.png' width='20' height='20'> Philips Rui Chi Candle Light Bulb" value="philips.light.candle" [#if DEVICE_TYPE="philips.light.candle"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/philips.light.downlight.png' width='20' height='20'> Philips Zhirui Downlight" value="philips.light.downlight" [#if DEVICE_TYPE="philips.light.downlight"#] selected[#endif#]></option>
					</optgroup>
					<optgroup label="Yeelight">
					<option data-content="<img src='../templates/xiaomimiio/img/small/yeelink.light.bslamp1.png' width='20' height='20'> Yeelight Bedside Lamp" value="yeelink.light.bslamp1" [#if DEVICE_TYPE="yeelink.light.bslamp1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/yeelink.light.color1.png' width='20' height='20'> Yeelight Color Bulb" value="yeelink.light.color1" [#if DEVICE_TYPE="yeelink.light.color1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/yeelink.light.mono1.png' width='20' height='20'> Yeelight White Bulb" value="yeelink.light.mono1" [#if DEVICE_TYPE="yeelink.light.mono1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/yeelink.light.ceiling1.png' width='20' height='20'> Yeelight Ceiling Light" value="yeelink.light.ceiling1" [#if DEVICE_TYPE="yeelink.light.ceiling1"#] selected[#endif#]></option>
					<option data-content="<img src='../templates/xiaomimiio/img/small/yeelink.light.strip1.png' width='20' height='20'> Yeelight LED Lightstrip" value="yeelink.light.strip1" [#if DEVICE_TYPE="yeelink.light.strip1"#] selected[#endif#]></option>
					</optgroup>
				</select>
			</div>
		</div>

		<div class="form-group">
			<label class="col-lg-3 control-label"[#if ERR_UPDATE_PERIOD#] style="color:red;font-weight:bold"[#endif#]>
				<#LANG_POLLING_PERIOD#>, <#LANG_SECONDS#>:
			</label>
			<div class="col-lg-4"><input type="text" class="form-control" name="update_period" value="[#if UPDATE_PERIOD!=""#][#UPDATE_PERIOD#][#else#]0[#endif#]" id="update_period"></div>
		</div>

		[#if SERIAL!=""#]
		<div class="form-group">
			<label class="col-lg-3 control-label">
				<#LANG_SERIAL#>:
			</label>
			<div class="col-lg-4">[#SERIAL#]</div>
		</div>
		[#endif#]
		
		[#if DEVICE_TYPE_CODE!=""#]
		<div class="form-group">
			<label class="col-lg-3 control-label">
				<#LANG_CODE#>:
			</label>
			<div class="col-lg-4">[#DEVICE_TYPE_CODE#]</div>
		</div>
		[#endif#]
		
		[#if MAC!=""#]
		<div class="form-group">
			<label class="col-lg-3 control-label"[#if ERR_MAC#] style="color:red;font-weight:bold"[#endif#]>
				MAC:
			</label>
			<div class="col-lg-4">[#MAC#]</div>
		</div>
		[#endif#]
		
		[#if MODEL!=""#]
		<div class="form-group">
			<label class="col-lg-3 control-label"[#if ERR_MODEL#] style="color:red;font-weight:bold"[#endif#]>
				MODEL:
			</label>
			<div class="col-lg-4">[#MODEL#]</div>
		</div>
		[#endif#]
		
		[#if HW_VER!=""#]
		<div class="form-group">
			<label class="col-lg-3 control-label"[#if ERR_HW_VER#] style="color:red;font-weight:bold"[#endif#]>
				HW_VER:
			</label>
			<div class="col-lg-4">[#HW_VER#]</div>
		</div>
		[#endif#]
		
		[#if DEVICE_TYPE="chuangmi.ir.v2"#]
		<div class="form-group">
			<label class="col-lg-3 control-label">
				<#LANG_XIMI_APP_TEACH1#>:
			</label>
			<div class="col-lg-4">
				<span onclick="" data-toggle="modal" data-target="#ir_learn" class="btn btn-success [#if TOKEN=="" || DEVICE_TYPE==""#]disabled[#endif#]" title="<#LANG_XIMI_APP_TEACH2#>" id="[#IP#]"><#LANG_XIMI_APP_TEACH#></span>
			</div>
		</div>
		[#endif#]
		
		<div class="form-group">
			<div class="col-lg-offset-3 col-lg-4">
				[#if ID!=""#]
				<button type="submit" name="subm" value="Submit" class="btn btn-primary"><#LANG_SUBMIT#></button>
				[#else ID#]
				<button type="submit" name="subm" value="Add" class="btn btn-primary"><#LANG_ADD#></button>
				[#endif ID#]
				<a href="?data_source=<#DATA_SOURCE#>" class="btn btn-default "><#LANG_STRING_BACK#></a>
				<input type="hidden" name="id" value="<#ID#>">
				<input type="hidden" name="view_mode" value="<#VIEW_MODE#>">
				<input type="hidden" name="edit_mode" value="<#EDIT_MODE#>">
				<input type="hidden" name="mode" value="update">
				<input type="hidden" name="data_source" value="<#DATA_SOURCE#>">
				<input type="hidden" name="tab" value="<#TAB#>">
			</div>
		</div>
	</fieldset>
</form>

[#if DEVICE_TYPE="chuangmi.ir.v2"#]
<div class="modal fade" id="ir_learn" tabindex="-1" role="dialog" aria-labelledby="about1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only"><#LANG_XXIMI_APP_CLOSE#></span></button>
				<b><#LANG_XIMI_APP_TEACH2#></b>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="float-right">
						<img src="../templates/xiaomimiio/img/mi_ir_learn.png" class="img-rounded">
					</div>
					<p class="float-left">
						<#LANG_XIMI_APP_TEACH_TEXT#>
					</p>
					<br><br>
					<div>
						<button class="btn btn-primary" onclick="startLearnIR();"><#LANG_XIMI_APP_START#></button>&nbsp;&nbsp;&nbsp;<b><i id="ir_learn_timer"></i></b>
					</div>
				</div>
				<div class="row">
					<br>
					<div>
						<pre class="pre-scrollable" id="ir_learn_log" style="word-wrap: break-word;"></pre>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	
	function startLearnIR(){
		
		var slot=getRandomInt(1,100000);
		var dopt='{"key":"'+slot+'"}';
		var url="/ajax/xiaomimiio.html?op=test_api_cmd&dip=[#IP#]&dtoken=[#TOKEN#]&dcmd=miIO.ir_learn&dopt="+dopt;

		$("#ir_learn_log").html('');
		
		Data = new Date();
		Hour = Data.getHours();
		Minutes = Data.getMinutes();
		Seconds = Data.getSeconds();
		
		//$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' ip = '+'[#IP#]'+'<br>');
		//$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' token = '+'[#TOKEN#]'+'<br>');
		//$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' '+url+'<br>');
		
		$.ajax({
			url: url,
			cache: false,
			success: function(html){
				//$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' '+html+'<br>');
				var resp = tryParseJSON(html);
				if (resp !== false) {
					if(typeof resp.error === 'undefined') {
						if((typeof resp.result !== 'undefined') && (resp.result === 0)) {
							$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' <#LANG_XIMI_APP_TRAINING#>.<br>');
							if($("#ir_learn_timer").html()=='') {
								$('#ir_learn_timer').html('10');
								setTimeout('learnTimer('+slot+')', 1000);
							}
						} else {
							$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' <#LANG_STRING_ERROR#> - bad response.<br>');
						}
					} else {
						$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' <#LANG_STRING_ERROR#> - '+resp.error.message+'<br>');
					}
				} else {
					$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' <#LANG_XIMI_APP_ERROR#>.<br>');
				}
			}
		});
	}
	
	function learnTimer(slot){
		var obj = document.getElementById('ir_learn_timer');
		var dopt='{"key":"'+slot+'"}';
		var url="/ajax/xiaomimiio.html?op=test_api_cmd&dip=[#IP#]&dtoken=[#TOKEN#]&dcmd=miIO.ir_read&dopt="+dopt;

		Data = new Date();
		Hour = Data.getHours();
		Minutes = Data.getMinutes();
		Seconds = Data.getSeconds();

		obj.innerHTML--;
		
		//$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' '+obj.innerHTML+'<br>');
		//$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' '+url+'<br>');
		
		if (obj.innerHTML == 0){
			$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' <#LANG_XIMI_APP_TRAINING_END#>.<br>');
			$('#ir_learn_timer').html('');
			setTimeout(function(){}, 1000);
		} else {
			$.ajax({
				url: url,
				cache: false,
				success: function(html){
					
					var resp = tryParseJSON(html);
					
					if (resp !== false) {
						if(typeof resp.error === 'undefined') {
							if((typeof resp.result !== 'undefined') && (resp.result !== '')) {
								
								if((typeof resp.result.code !== 'undefined') && (typeof resp.result.key !== 'undefined')) {
									if((resp.result.code!=='') && (resp.result.code.length > 10) && (resp.result.key == slot)) {
										$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' <#LANG_XIMI_APP_SUCCESSFULLY#><br>');
										$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' '+resp.result.code+'<br>');
										$('#ir_learn_timer').html('');
										setTimeout(function(){}, 1000);
									} else if (resp.result.code==='') {
										setTimeout('learnTimer('+slot+')', 1000);
									}  
								}
							}
						} else {
							$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' <#LANG_STRING_ERROR#> - '+resp.error.message+'<br>');
							$('#ir_learn_timer').html('');
							setTimeout(function(){}, 1000);
						}
					} else {
						$('#ir_learn_log').append(Hour+":"+Minutes+":"+Seconds+' <#LANG_XIMI_APP_ERROR#>.<br>');
						$('#ir_learn_timer').html('');
						setTimeout(function(){}, 1000);
					}
				}
			});	
		}
	}
	
	function tryParseJSON (jsonString){
		try {
			var o = JSON.parse(jsonString);
			if (o && typeof o === "object") return o;
		}
		catch (e) { }
		return false;
	};
	
	function getRandomInt(min, max){
		return Math.floor(Math.random() * (max - min + 1)) + min;
	}
	
</script>
[#endif#]

<script>

var script = document.createElement('script');
script.src = "../templates/xiaomimiio/css/bootstrap-select.min.js"
document.body.appendChild(script);

script.onload = function() {
	// после подгрузки js-файла перерисуем элемент select
	$('.selectpicker').selectpicker('render');
}

</script>